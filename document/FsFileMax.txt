系统内核参数优化 (sysctl)
这些参数主要调整 Linux 内核的网络栈，以更好地处理高并发连接。
# 最大文件描述符数
fs.file-max = 1000000

# TCP 连接 TIME_WAIT 状态最大数量
net.ipv4.tcp_max_tw_buckets = 200000

# TIME_WAIT 状态的 TCP 连接重用
net.ipv4.tcp_tw_reuse = 1

# 最大 TCP 连接数
net.ipv4.tcp_max_syn_backlog = 262144

# SYN_COOKIES 防护，防止 SYN Flood 攻击
net.ipv4.tcp_syncookies = 1

# TCP 连接保持活动的时间
net.ipv4.tcp_keepalive_time = 600

# TCP 连接探测的间隔时间
net.ipv4.tcp_keepalive_intvl = 15

# TCP 连接探测的次数
net.ipv4.tcp_keepalive_probes = 5

# 增加本地端口范围
net.ipv4.ip_local_port_range = 1024 65535

# 减少处于 FIN-WAIT-2 连接状态的时间
net.ipv4.tcp_fin_timeout = 30

# 最大的跟踪连接数
net.netfilter.nf_conntrack_max = 1048576

# 确保以上更改生效
sysctl -p


Nginx 配置优化 (nginx.conf)
以下是一个优化的 Nginx 配置示例，你需要根据你的实际需求进行调整。
worker_processes  auto; # 根据 CPU 核心数自动调整 worker 进程数
worker_rlimit_nofile 1000000; # 限制 worker 进程的最大文件描述符数

events {
    worker_connections  65535; # 每个 worker 进程的最大连接数
    use epoll; # 使用 epoll 事件模型，Linux 下推荐
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on; # 启用 sendfile 系统调用，提高静态文件传输效率
    tcp_nopush     on; # 减少网络报文段数量
    tcp_nodelay    on; # 禁用 Nagle 算法，减少延迟

    keepalive_timeout  65; # 长连接超时时间
    keepalive_requests 10000; # 单个长连接上的最大请求数

    client_max_body_size 10m; # 客户端请求 body 最大大小

    # 优化 Gzip 压缩
    gzip on;
    gzip_min_length  1k;
    gzip_buffers     4 16k;
    gzip_comp_level 6;
    gzip_types       text/plain application/x-javascript text/css application/json application/xml text/xml application/javascript;

    # 连接超时设置
    client_header_timeout 10s;
    client_body_timeout 10s;
    send_timeout 10s;

    # upstream 配置，用于反向代理
    upstream backend {
        server 127.0.0.1:8080; # 后端服务器地址
        # ... 其他 upstream 配置，如负载均衡策略等
        keepalive 64; # upstream 的长连接数量
    }

    server {
        listen       80;
        server_name  localhost;

        location / {
            proxy_pass http://backend; # 反向代理到后端服务器
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # 代理超时设置
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
            proxy_send_timeout 5s;
            proxy_http_version 1.1;
            proxy_set_header Connection ""; # 关闭 proxy 与 backend 之间的 keepalive，由 upstream 的 keepalive 控制
        }

    }
}
