git clone https://github.com/matrix-org/dendrite
go build -o bin/ ./cmd/...
./bin/generate-keys --private-key matrix_key.pem
./bin/generate-keys --tls-cert server.crt --tls-key server.key
cp dendrite-sample.yaml dendrite.yaml
./bin/dendrite  --config dendrite.yaml

\l 列出所有数据库。
\c mydatabase 连接到指定的数据库。
\dt 显示当前数据库中的所有表。
\d table_name 显示指定表的详细信息。

sudo apt install postgresql
sudo -u postgres psql
CREATE DATABASE mydatabase;
DROP DATABASE mydatabase;
CREATE USER myuser WITH ENCRYPTED PASSWORD '135246';
GRANT ALL PRIVILEGES ON DATABASE mydatabase TO myuser;
connection_string: postgresql://myuser:135246@localhost/mydatabase?sslmode=disable
DROP TABLE public.events;

ALTER USER postgres PASSWORD '135246';
sudo systemctl restart postgresql

connection_string: postgresql://postgres:135246@localhost/postgres?sslmode=disable
nohup ./bin/dendrite  --config dendrite.yaml -http-bind-address 127.0.0.1:8008 -really-enable-open-registration &
./bin/create-account -config dendrite.yaml -username henry 

citus集群
curl https://install.citusdata.com/community/deb.sh | sudo bash
sudo apt install postgresql-14-citus-12.1

sudo vim /etc/postgresql/14/main/postgresql.conf
listen_addresses = '*'
shared_preload_libraries = 'citus'

sudo vim /etc/postgresql/14/main/pg_hba.conf
host    all             all             0.0.0.0/0               trust

sudo systemctl restart postgresql
sudo -i -u postgres psql -c "CREATE EXTENSION citus;"

sudo -i -u postgres psql
SELECT citus_set_coordinator_host('192.168.163.141', 5432);

SELECT citus_add_node('192.168.163.142', 5432);
SELECT citus_add_node('192.168.163.143', 5432);

SELECT master_remove_node('192.168.163.143', 5432);
SELECT undistribute_table('public.events');

SELECT rebalance_table_shards();
SELECT * FROM citus_get_active_worker_nodes();

CREATE TABLE events (
  device_id bigint,
  event_id bigserial,
  event_time timestamptz default now(),
  data jsonb not null,
  PRIMARY KEY (device_id, event_id)
);

SELECT create_distributed_table('events', 'device_id');

INSERT INTO events (device_id, data)
SELECT s % 100, ('{"measurement":'||random()||'}')::jsonb FROM generate_series(1,2) s;

SELECT * FROM events;
DROP TABLE public.events;
DROP SEQUENCE public.events_event_id_seq;

集群部署
sudo apt install python3-pip
pip  install psycopg2-binary
pip install patroni[etcd]
sudo apt install etcd
systemctl disable postgresql

PATH=$PATH:/usr/lib/postgresql/14/bin
source ~/.bashrc

主节点配置
host replication replicator 192.168.163.142/32 trust
host replication replicator 192.168.163.143/32 trust

sudo vim /etc/default/etcd
ETCD_LISTEN_CLIENT_URLS="http://0.0.0.0:2379"
ETCD_LISTEN_PEER_URLS="http://0.0.0.0:2380"
ETCD_ADVERTISE_CLIENT_URLS="http://0.0.0.0:2379"
sudo systemctl restart etcd

sudo apt install haproxy
sudo vim /etc/haproxy/haproxy.cfg
sudo systemctl restart haproxy
sudo haproxy -f /etc/haproxy/haproxy.cfg -d

patronictl -c config.yml list
patronictl -c config.yml switchover
patronictl -c config.yml failover

patronictl -c config.yml pause
patronictl -c config.yml resume
patronictl -c config.yml reload

SELECT * FROM pg_replication_slots;
psql -h 192.168.163.141 -p 5432 -U postgres -d postgres
psql -h 192.168.163.141 -p 5433 -U postgres -d postgres
    superuser:
      username: postgres
      password: secret

global
    log /dev/log local0
    log /dev/log local1 notice
    user haproxy
    group haproxy
    maxconn 4000
    daemon

defaults
    log global
    mode tcp
    timeout connect 10s
    timeout client 30s
    timeout server 30s
    retries 3

frontend postgres_front
    bind *:5433
    default_backend postgres_back

backend postgres_back
    mode tcp
    balance leastconn
    option tcp-check
    tcp-check connect port 5432

    server node1 192.168.163.141:5432 check fall 3 rise 2 inter 2000 maxconn 100 weight 100
    #server node2 192.168.163.142:5432 check fall 3 rise 2 inter 2000 maxconn 50 weight 50
    #server node3 192.168.163.143:5432 check fall 3 rise 2 inter 2000 maxconn 50 weight 50

frontend stats_front
    bind *:8000
    mode http
    stats enable
    stats uri /haproxy_stats
    stats realm Haproxy\ Statistics
    stats auth admin:admin

scope: postgres
namespace: /db/
name: node1

restapi:
  listen: 0.0.0.0:8008
  connect_address: 192.168.163.141:8008

etcd:
  host: 192.168.163.141:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 5
    maximum_lag_on_failover: 1048576
  initdb:
    - encoding: UTF8
    - data-checksums
  pg_hba:
    - host replication replicator 127.0.0.1/32 md5
    - host all all 0.0.0.0/0 md5
  users:
    admin:
      password: admin
      options:
        - createrole
        - createdb

postgresql:
  listen: 0.0.0.0:5432
  connect_address: 192.168.163.141:5432
  data_dir: /home/mason/data/pgdata
  pgpass: /home/mason/tmp/pgpass
  authentication:
    replication:
      username: replicator
      password: secret
    superuser:
      username: postgres
      password: secret
  parameters:
    unix_socket_directories: '.'

scope: postgres
namespace: /db/
name: node2
restapi:
listen: 0.0.0.0:8008
connect_address: 192.168.163.142:8008
etcd:
host: 192.168.163.141:2379
bootstrap:
dcs:
ttl: 30
loop_wait: 10
retry_timeout: 5
maximum_lag_on_failover: 1048576
initdb:
- encoding: UTF8
- data-checksums
pg_hba:
- host replication replicator 127.0.0.1/32 md5
- host all all 0.0.0.0/0 md5
users:
admin:
password: admin
options:
- createrole
- createdb
postgresql:
listen: 0.0.0.0:5432
connect_address: 192.168.163.142:5432
data_dir: /home/mason/data/pgdata
pgpass: /home/mason/tmp/pgpass
authentication:
replication:
username: replicator
password: secret
superuser:
username: postgres
password: secret
parameters:
unix_socket_directories: '.'

scope: postgres
namespace: /db/
name: node3

restapi:
  listen: 0.0.0.0:8008
  connect_address: 192.168.163.143:8008

etcd:
  host: 192.168.163.141:2379
id_rsa:
-----BEGIN RSA PRIVATE KEY-----
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
-----END RSA PRIVATE KEY-----

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 5
    maximum_lag_on_failover: 1048576
  initdb:
    - encoding: UTF8
    - data-checksums
  pg_hba:
    - host replication replicator 127.0.0.1/32 md5
    - host all all 0.0.0.0/0 md5
  users:
    admin:
      password: admin
      options:
        - createrole
        - createdb

postgresql:
  listen: 0.0.0.0:5432
  connect_address: 192.168.163.143:5432
  data_dir: /home/mason/data/pgdata
  pgpass: /home/mason/tmp/pgpass
  authentication:
    replication:
      username: replicator
      password: secret
    superuser:
      username: postgres
      password: secret
  parameters:
    unix_socket_directories: '.'
